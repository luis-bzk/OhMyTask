import{getProjectUrl,cleanTasksHTML}from"./functions.js";import{showAlert,showTaskForm}from"./newTasks.js";import{tasks,setTasks,filteredTasks,setFilteredTasks}from"./globalVariables.js";export const updateTask=async function(t){const{id:e,name:s,state:a}=t,n=new FormData;n.append("id",e),n.append("name",s),n.append("state",a),n.append("project_id",getProjectUrl());try{const t="http://localhost:3000/api/task/update",o=await fetch(t,{method:"POST",body:n}),c=await o.json();if("success"===c.answerUpdate.type){const{message:t,type:n}=c.answerUpdate;showAlert(t,n);const o=document.querySelector(".modal"),l=document.querySelector(".form-task");o&&setTimeout(()=>{l.classList.add("close"),setTimeout(()=>{o.remove()},500)},1e3);const d=tasks.map(t=>(t.id===e&&(t.state=a,t.name=s),t));setTasks(d),showTasks()}}catch(t){console.log(t)}};const changeTaskState=t=>{const e="1"===t.state?"0":"1";t.state=e,updateTask(t)},confirmDeleteTask=t=>{Swal.mixin({customClass:{confirmButton:"sweetalert btn-success",cancelButton:"sweetalert btn-danger",title:"sweetalert text",actions:"sweetalert actions"},buttonsStyling:!1}).fire({title:"Are you sure you want to delete this Task?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",cancelButtonText:"No, cancel!",reverseButtons:!0,width:600}).then(e=>{e.isConfirmed&&async function(t){const{id:e,name:s,state:a}=t,n=new FormData;n.append("id",e),n.append("name",s),n.append("state",a),n.append("project_id",getProjectUrl());try{const e="http://localhost:3000/api/task/delete",s=await fetch(e,{method:"POST",body:n}),a=await s.json(),{result:o,message:c,type:l}=a.deleteResult;o&&(showAlert(c,l),setTasks(tasks.filter(e=>e.id!==t.id)),showTasks())}catch(t){console.log(t)}}(t)})},totalPending=()=>{const t=tasks.filter(t=>"0"===t.state),e=document.querySelector("#pendings");0===t.length?e.disabled=!0:e.disabled=!1},totalComplete=()=>{const t=tasks.filter(t=>"1"===t.state),e=document.querySelector("#complete");0===t.length?e.disabled=!0:e.disabled=!1};export const showTasks=()=>{cleanTasksHTML(),totalPending(),totalComplete();const t=filteredTasks.length?filteredTasks:tasks;if(0===t.length){const t=document.querySelector("#tasks-list"),e=document.createElement("DIV");return e.textContent="There aren't tasks",e.classList.add("not-tasks"),void t.appendChild(e)}const e={0:"Pending",1:"Complete"};t.forEach(t=>{const s=document.querySelector("#tasks-list"),a=document.createElement("LI");a.classList.add("task"),a.dataset.taskId=t.id;const n=document.createElement("P");n.textContent=t.name,n.classList.add("task__name");const o=document.createElement("DIV");o.classList.add("task__options");const c=document.createElement("I");c.classList.add("fa-solid"),c.classList.add("fa-pen-to-square"),c.classList.add("task-edit"),c.ondblclick=function(){showTaskForm(!0,{...t})};const l=document.createElement("BUTTON");l.classList.add("task-state"),l.classList.add(""+e[t.state].toLowerCase()),l.textContent=e[t.state],l.dataset.taskState=t.state,l.ondblclick=function(){changeTaskState({...t})};const d=document.createElement("BUTTON");d.classList.add("task-delete"),d.textContent="Delete",d.dataset.taskDelete=t.id,d.ondblclick=function(){confirmDeleteTask({...t})},o.appendChild(c),o.appendChild(l),o.appendChild(d),a.appendChild(n),a.appendChild(o),s.appendChild(a)})};const filterSearch=document.querySelectorAll("#filters input[type='radio']"),filterTasks=t=>{const e=t.target.value;setFilteredTasks(""!==e?tasks.filter(t=>t.state===e):[]),showTasks()};filterSearch.forEach(t=>{t.addEventListener("input",filterTasks)});export const getTasks=async function(){try{const t="/api/tasks?id="+getProjectUrl(),e=await fetch(t),s=await e.json();setTasks(s.tasks),showTasks()}catch(t){console.log(t)}};