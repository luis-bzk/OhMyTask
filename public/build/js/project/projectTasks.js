import{getProjectUrl,cleanTasksHTML}from"./functions.js";import{showAlert,showTaskForm}from"./newTasks.js";import{tasks,setTasks}from"./globalVariables.js";export const updateTask=async function(t){const{id:e,name:s,state:a}=t,n=new FormData;n.append("id",e),n.append("name",s),n.append("state",a),n.append("project_id",getProjectUrl());try{const t="http://localhost:3000/api/task/update",o=await fetch(t,{method:"POST",body:n}),c=await o.json();if("success"===c.answerUpdate.type){const{message:t,type:n}=c.answerUpdate;showAlert(t,n);const o=document.querySelector(".modal"),d=document.querySelector(".form-task");o&&setTimeout(()=>{d.classList.add("close"),setTimeout(()=>{o.remove()},500)},1e3);const l=tasks.map(t=>(t.id===e&&(t.state=a,t.name=s),t));setTasks(l),showTasks()}}catch(t){console.log(t)}};const changeTaskState=t=>{const e="1"===t.state?"0":"1";t.state=e,updateTask(t)},confirmDeleteTask=t=>{Swal.mixin({customClass:{confirmButton:"sweetalert btn-success",cancelButton:"sweetalert btn-danger",title:"sweetalert text",actions:"sweetalert actions"},buttonsStyling:!1}).fire({title:"Are you sure you want to delete this Task?",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",cancelButtonText:"No, cancel!",reverseButtons:!0,width:600}).then(e=>{e.isConfirmed&&async function(t){const{id:e,name:s,state:a}=t,n=new FormData;n.append("id",e),n.append("name",s),n.append("state",a),n.append("project_id",getProjectUrl());try{const e="http://localhost:3000/api/task/delete",s=await fetch(e,{method:"POST",body:n}),a=await s.json(),{result:o,message:c,type:d}=a.deleteResult;o&&(showAlert(c,d),setTasks(tasks.filter(e=>e.id!==t.id)),showTasks())}catch(t){console.log(t)}}(t)})};export const showTasks=()=>{if(cleanTasksHTML(),0===tasks.length){const t=document.querySelector("#tasks-list"),e=document.createElement("DIV");return e.textContent="There aren't tasks",e.classList.add("not-tasks"),void t.appendChild(e)}const t={0:"Pending",1:"Complete"};tasks.forEach(e=>{const s=document.querySelector("#tasks-list"),a=document.createElement("LI");a.classList.add("task"),a.dataset.taskId=e.id;const n=document.createElement("P");n.textContent=e.name,n.classList.add("task__name");const o=document.createElement("DIV");o.classList.add("task__options");const c=document.createElement("I");c.classList.add("fa-solid"),c.classList.add("fa-pen-to-square"),c.classList.add("task-edit"),c.ondblclick=function(){showTaskForm(!0,{...e})};const d=document.createElement("BUTTON");d.classList.add("task-state"),d.classList.add(""+t[e.state].toLowerCase()),d.textContent=t[e.state],d.dataset.taskState=e.state,d.ondblclick=function(){changeTaskState({...e})};const l=document.createElement("BUTTON");l.classList.add("task-delete"),l.textContent="Delete",l.dataset.taskDelete=e.id,l.ondblclick=function(){confirmDeleteTask({...e})},o.appendChild(c),o.appendChild(d),o.appendChild(l),a.appendChild(n),a.appendChild(o),s.appendChild(a)})};export const getTasks=async function(){try{const t="/api/tasks?id="+getProjectUrl(),e=await fetch(t),s=await e.json();setTasks(s.tasks),showTasks()}catch(t){console.log(t)}};